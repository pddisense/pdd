#!/bin/bash
# Copyright 2017-2018 UCL / Vincent Primault <v.primault@ucl.ac.uk>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -e

dist_dir=dist
rm -rf ${dist_dir} && mkdir -p ${dist_dir}

function print_help_and_exit {
cat <<EOF
Usage: $0 [-help] [-publish]

  -help      Print this help message and exit
  -publish   Publish (default: false, which does not publish anything)
EOF
exit 0
}

publish=0
for opt in "$@"
do
  case "$opt" in
    -publish)
      publish=1
      ;;
    -help)
      print_help_and_exit
      ;;
    *)
      echo "Unknown option $opt"
      print_help_and_exit
      ;;
  esac
done

bazel build pdd/node/ucl/pdd/chrome:package --define env=production && \
  cp bazel-bin/pdd/node/ucl/pdd/chrome/package.zip ${dist_dir}/chrome.zip

bazel build pdd/java/ucl/pdd/dashboard && \
  bazel build pdd/java/ucl/pdd/dashboard:dashboard_deploy.jar --define env=production && \
  cp bazel-bin/pdd/java/ucl/pdd/dashboard/dashboard_deploy.jar ${dist_dir}/pdd-dashboard.jar

bazel build pdd/java/ucl/pdd/server && \
  bazel build pdd/java/ucl/pdd/server:server_deploy.jar --define env=production && \
  cp bazel-bin/pdd/java/ucl/pdd/server/server_deploy.jar ${dist_dir}/pdd-server.jar

if [[ ${publish} == 1 ]]; then
  echo "Publishing Docker images..."
  bazel run pdd/java/ucl/pdd/server:publish
  bazel run pdd/java/ucl/pdd/dashboard:publish
fi
